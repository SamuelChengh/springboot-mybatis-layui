<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>设置权限</title>
    <link href="/resources/static/layui/css/layui.css" rel="stylesheet"/>
    <script src="/resources/static/layui/layui.js"></script>
</head>

<style type="text/css">
    .layui-group{
        margin-top: 10px;
    }

    .layui-child-row {
        margin-top: 10px;
    }

    .layui-parent-label {
        font-size: 25px;
        font-weight: bold;
    }
</style>

<body>
<form class="layui-form" action="" lay-filter="form">

    <div id="auth-container" class="layui-container"></div>

    <div style="display: none">
        <button class="layui-btn" lay-submit="" lay-filter="submit">确定</button>
        <button class="layui-btn" lay-submit="" lay-filter="checkAll">全选</button>
        <button class="layui-btn" lay-submit="" lay-filter="unCheckAll">取消全选</button>
    </div>
</form>

<script type="text/javascript">
    var record;
    function setRecordData(rec) {
        record = rec;
    }

    layui.config({
        base: '/resources/static/layui/base/'
    }).use(['form', 'baselist'], function () {
        $ = layui.jquery;
        var form = layui.form,
            baselist = layui.baselist;

        createAuth(form);

        // 全选
        form.on('submit(checkAll)', function (data) {
            $("input[name='authId']").each(function () {
                $(this).prop("checked", true);
            })
            form.render('checkbox');
            return false;
        });

        // 取消全选
        form.on('submit(unCheckAll)', function (data) {
            $("input[name='authId']").each(function () {
                $(this).prop("checked", false);
            })
            form.render('checkbox');
            return false;
        });

        // 确定
        form.on('submit(submit)', function (data) {
            var authIdArray = [];
            $("input:checkbox[name='authId']:checked").each(function () { // 遍历name=authId选中的复选框
                var authId = $(this).val();
                authIdArray.push(parseInt(authId));
            });

            if (authIdArray.length == 0) {
                layer.alert('对不起，您选择的权限为空！', {
                    icon: 5
                });
                return false;
            }

            var rec = {};
            rec.id = record.id;
            rec.authIds = authIdArray.toString();

            baselist.submitForm("/role/updateAuthority", rec);

            return false;
        });
    });

    function createAuth(form) {
        $.ajax({
            type: "GET",
            url: "/role/getAuthority",
            data: {roleId: record.id},
            dataType: "json",
            success: function (res) {
                var parentHtml = document.getElementById("auth-container");
                for (var i = 0; i < res.length; i++) {
                    var parentMenu = res[i];

                    var div = document.createElement("div");
                    div.setAttribute("class", "layui-group");

                    // 父节点
                    var parentDiv = document.createElement("div");
                    parentDiv.setAttribute("class", "layui-row");

                    var parentColDiv = document.createElement("div");
                    parentColDiv.setAttribute("class", "layui-col-xs12 layui-col-sm12 layui-col-md12");

                    var input = document.createElement("input");   // input
                    input.setAttribute("type", "checkbox");
                    input.setAttribute("name", "authId");
                    input.setAttribute("value", parentMenu.parentId);
                    input.setAttribute("lay-skin", "primary");
                    if(parentMenu.checked){
                        input.setAttribute("checked", "");
                    }
                    parentColDiv.appendChild(input);

                    var label = document.createElement("label");   // label
                    label.setAttribute("class", "layui-parent-label");
                    label.appendChild(document.createTextNode(parentMenu.parentName));
                    parentColDiv.appendChild(label);

                    parentDiv.appendChild(parentColDiv);

                    div.appendChild(parentDiv);

                    // 子节点
                    var childDiv = document.createElement("div");
                    childDiv.setAttribute("class", "layui-row");

                    for(var j=0; j<parentMenu.childMenus.length; j++){
                        var childColDiv = document.createElement("div");
                        childColDiv.setAttribute("class", "layui-col-xs3 layui-col-sm3 layui-col-md3 layui-child-row");

                        var childInput = document.createElement("input");   // input
                        childInput.setAttribute("type", "checkbox");
                        childInput.setAttribute("name", "authId");
                        childInput.setAttribute("value", parentMenu.childMenus[j].id);
                        childInput.setAttribute("lay-skin", "primary");
                        childInput.setAttribute("title", parentMenu.childMenus[j].name);
                        if(parentMenu.childMenus[j].checked){
                            childInput.setAttribute("checked", "");
                        }

                        childColDiv.appendChild(childInput);

                        childDiv.appendChild(childColDiv);
                    }

                    div.appendChild(childDiv);

                    parentHtml.appendChild(div);
                }

                form.render('checkbox');
            }
        })
    }
</script>
</body>
</html>