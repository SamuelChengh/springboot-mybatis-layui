<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>账号管理 | 账号列表</title>
    <link href="/resources/static/layui/css/layui.css" rel="stylesheet"/>
    <script src="/resources/static/layui/layui.js"></script>
</head>

<body>
<!-- 搜索栏 -->
<form class="layui-form" action="" lay-filter="searchForm">
    <div class="layui-form-item">

        <div class="layui-inline">
            <label class="layui-form-label">账号:</label>
            <div class="layui-input-inline">
                <input class="layui-input" id="loginName" name="loginName" autocomplete="off">
            </div>
        </div>

        <div class="layui-inline">
            <button class="layui-btn" lay-submit="" lay-filter="search"><i class="layui-icon layui-icon-search"></i>查询
            </button>
            <button class="layui-btn layui-btn-primary" type="reset">重置</button>
        </div>

    </div>
</form>

<!-- table -->
<table id="lay_table" class="layui-hide" lay-filter="tbf"></table>

<!-- 头工具栏toolbar -->
<script type="text/html" id="toolbar">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add"><i class="layui-icon layui-icon-add-1"></i>新增</button>
    </div>
</script>

<!-- 工具条tool -->
<script type="text/html" id="tool">
    <a class="layui-btn layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete"><i class="layui-icon layui-icon-delete"></i>删除</a>
</script>

<!-- 状态templet -->
<script type="text/html" id="statusTemp">
    {{#  if(d.status === 1){ }}
        <input type="checkbox" checked name="status" value="{{ d.id }}" lay-skin="switch" lay-text="开启|禁用" lay-filter="status">
    {{#  } else { }}
        <input type="checkbox" name="status" value="{{ d.id }}" lay-skin="switch" lay-text="开启|禁用" lay-filter="status">
    {{#  } }}
</script>

<script type="text/javascript">
    layui.use(['form', 'table'], function () {
        $ = layui.jquery;       // 引入jquery
        var form = layui.form,
            table = layui.table;

        // 查询
        form.on('submit(search)', function (data) {
            table.reload('tb', {
                where: {
                    loginName: data.field.loginName
                }
            });
            return false;
        });

        // 渲染table
        table.render({
            id: 'tb',
            title: '账号',
            elem: '#lay_table',
            method: 'post',
            url: '/user/list',
            page: {
                layout: ['prev', 'page', 'next', 'skip', 'limit', 'count'], //自定义分页布局
                groups: 1,     //只显示 1 个连续页码
                first: false,  //不显示首页
                last: false    //不显示尾页
            },
            limit: 15,
            limits: [15, 30, 60, 100],
            loading: true,
            cellMinWidth: 100,
            toolbar: '#toolbar',
            cols: [[
                {type: 'numbers'},
                {field: 'loginName', title: '账号', align: 'center'},
                {field: 'nickName', title: '昵称', align: 'center'},
                {field: 'remark', title: '备注', width: '200', align: 'center'},
                {field: 'status', title: '状态', align: 'center', templet: '#statusTemp'},
                {field: 'createdDate', title: '创建时间', width: '160', align: 'center'},
                {field: 'updatedDate', title: '修改时间', width: '160', align: 'center'},
                {title: '操作', width: '150', align: 'center', toolbar: '#tool'}
            ]],
            text: {
                none: '暂无相关数据'
            }
        });

        // 监听头工具栏toolbar
        table.on('toolbar(tbf)', function (obj) {
            switch (obj.event) {
                case 'add':
                    layer.open({
                        type: 2,
                        title: '新增账号',
                        content: '/user/add',
                        skin: 'layui-layer-molv',
                        offset: '0px',
                        resize: false,
                        success: function (layero, index) {
                            layer.iframeAuto(index);  // iframe层自适应
                        }
                    })
                    break;
            }
        });

        // 监听工具条tool
        table.on('tool(tbf)', function (obj) {
            var record = obj.data;

            switch (obj.event) {
                case 'edit':
                    layer.open({
                        id: record.userId,
                        type: 2,
                        title: '编辑账号',
                        content: '/user/update',
                        skin: 'layui-layer-molv',
                        offset: '0px',
                        resize: false,
                        success: function (layero, index) {
                            // 获取子页面的iframe
                            var iframe = layero.find("iframe")[0].contentWindow;
                            // 向子页面的全局函数setRecordData传参
                            iframe.setRecordData(record);

                            layer.iframeAuto(index);  // iframe层自适应
                        }
                    })
                    break;
                case 'delete':
                    parent.layer.confirm('您确定要删除该条记录吗？', {
                        title: '温馨提示',
                        icon: 3
                    }, function (index) {
                        $.post('/user/delete/' + record.userId, function (res) {
                            if (res.success) {
                                layer.alert(res.message, {
                                    icon: 1,
                                }, function () {
                                    table.reload("tb");
                                });
                            } else {
                                layer.msg(res.message, {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                    break;
            }
            ;
        });

        // 监听行双击事件
        table.on('rowDouble(tbf)', function (obj) {
            var record = obj.data;
            layer.open({
                id: record.userId,
                type: 2,
                title: '编辑账号',
                content: '/user/update',
                skin: 'layui-layer-molv',
                offset: '0px',
                resize: false,
                success: function (layero, index) {
                    // 获取子页面的iframe
                    var iframe = layero.find("iframe")[0].contentWindow;
                    // 向子页面的全局函数setRecordData传参
                    iframe.setRecordData(record);

                    layer.iframeAuto(index);  // iframe层自适应
                }
            })
        });

        // 监听switch开关: 状态status
        form.on('switch(status)', function(data){
            var record = {};
            record.id = data.value;
            if(data.elem.checked){
                record.status = 1;
            }else{
                record.status = 0;
            }

            $.ajax({
                type : "POST",
                url : "/user/update",
                data: record,
                dataType : "json",
                success : function(res) {
                    if(res.success){
                        table.reload("tb");
                    }else{
                        layer.msg(res.message, {icon: 2});
                    }
                }
            })
        });
    });
</script>
</body>
</html>